# escape=`

ARG BASE_IMAGE=artifactory.devsh.eu/godbolt/base:latest

ARG GIT_CJSON="${THIS_PROJECT_GIT_REPOSITORIES_DIRECTORY}\c-json"
ARG GIT_CJSON_BUILD_DIRECTORY="${THIS_PROJECT_DEPENDENCY_BUILD_DIRECTORY}\c-json"
ARG CJSON_INSTALL_DIRECTORY="${GIT_CJSON_BUILD_DIRECTORY}\install"
ARG GIT_SPIRV_HEADERS="${THIS_PROJECT_GIT_REPOSITORIES_DIRECTORY}\SPIRV-Headers"
ARG GIT_SPIRV_BUILD_DIRECTORY="${THIS_PROJECT_DEPENDENCY_BUILD_DIRECTORY}\SPIRV-Headers"
ARG SPIRV_HEADERS_INSTALL_DIRECTORY="${GIT_SPIRV_BUILD_DIRECTORY}\install"

FROM ${BASE_IMAGE}

SHELL ["cmd", "/S", "/C"]

ARG GIT_CJSON
ARG GIT_CJSON_BUILD_DIRECTORY
ARG CJSON_INSTALL_DIRECTORY

RUN `
	# c-json
	`
	mkdir "%GIT_CJSON%" `
	`
	&& git clone --depth=1 https://github.com/json-c/json-c.git "%GIT_CJSON%" `
	`
	&& cmake -S "%GIT_CJSON%" -B "%GIT_CJSON_BUILD_DIRECTORY%" -D "CMAKE_INSTALL_PREFIX=%CJSON_INSTALL_DIRECTORY%"` 
	`
	&& cmake --build "%GIT_CJSON_BUILD_DIRECTORY%" --config Release`
	`
	&& cmake --install "%GIT_CJSON_BUILD_DIRECTORY%" --prefix "%CJSON_INSTALL_DIRECTORY%" --config Release `
	`
	&& setx CJSON_INSTALL_DIRECTORY "%CJSON_INSTALL_DIRECTORY%" /M

ARG GIT_SPIRV_HEADERS
ARG GIT_SPIRV_BUILD_DIRECTORY
ARG SPIRV_HEADERS_INSTALL_DIRECTORY

RUN `
	# SPIRV-Headers
	`
	mkdir "%GIT_SPIRV_HEADERS%" `
	`
	&& git clone --depth=1 https://github.com/KhronosGroup/SPIRV-Headers "%GIT_SPIRV_HEADERS%" `
	`
	&& cmake -S "%GIT_SPIRV_HEADERS%" -B "%GIT_SPIRV_BUILD_DIRECTORY%" -DCMAKE_INSTALL_PREFIX="%SPIRV_HEADERS_INSTALL_DIRECTORY%" `
	`
	&& cmake --install "%GIT_SPIRV_BUILD_DIRECTORY%" --prefix "%SPIRV_HEADERS_INSTALL_DIRECTORY%" --config Release `
	`
	&& setx SPIRV_HEADERS_INSTALL_DIRECTORY "%SPIRV_HEADERS_INSTALL_DIRECTORY%" /M

ENTRYPOINT ["VsDevCmd.bat", "&&", "powershell.exe", "-NoLogo", "-ExecutionPolicy", "Bypass"]